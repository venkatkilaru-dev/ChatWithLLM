@page "/counter"
@using ChatWithLLM.Models
@using System.Text.Json

<h3>Chat History</h3>

@if (history == null)
{
    <p>Loading...</p>
}
else if (history.Count == 0)
{
    <p>No chat history yet.</p>
}
else
{
    <div class="chat-container">

        @foreach (var item in history)
        {
            <!-- USER MESSAGE (RIGHT SIDE) -->
            <div class="chat-message user">
                <div class="bubble user-bubble">
                    @item.UserMessage
                </div>
                <div class="timestamp">@item.Timestamp.ToString("g")</div>
            </div>

            <!-- AI MESSAGE (LEFT SIDE) -->
            <div class="chat-message ai">
                <div class="bubble ai-bubble">
                    @((MarkupString)item.AiResponse)
                </div>
                <div class="timestamp">@item.Timestamp.ToString("g")</div>
            </div>
        }
    </div>
}

<style>
    .chat-container {
        display: flex;
        flex-direction: column;
        gap: 20px;
        margin-top: 20px;
        padding-bottom: 40px;
        max-height: 80vh;
        overflow-y: auto;
    }

    .chat-message {
        display: flex;
        flex-direction: column;
        max-width: 70%;
    }

    .chat-message.user {
        align-self: flex-end;
        text-align: right;
    }

    .chat-message.ai {
        align-self: flex-start;
        text-align: left;
    }

    .bubble {
        padding: 12px 16px;
        border-radius: 14px;
        font-size: 15px;
        line-height: 1.5;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    .user-bubble {
        background-color: #007bff;
        color: white;
        border-bottom-right-radius: 0;
    }

    .ai-bubble {
        background-color: #f1f1f1;
        color: #333;
        border-bottom-left-radius: 0;
    }

    .timestamp {
        font-size: 11px;
        color: gray;
        margin-top: 4px;
    }
</style>

@code {
    List<ChatHistoryItem> history;

    protected override async Task OnInitializedAsync()
    {
        var file = Path.Combine("wwwroot", "chatHistory.json");

        if (File.Exists(file))
        {
            var json = await File.ReadAllTextAsync(file);
            history = JsonSerializer.Deserialize<List<ChatHistoryItem>>(json);
        }
        else
        {
            history = new();
        }
    }
}
